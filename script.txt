const questionsDB = {
    easy: [
        { text: "Qual o valor de seno(30¬∞)?", options: ["1", "0.5", "‚àö3/2", "‚àö2/2"], correct: 1, explanation: "Sen(30¬∞) √© um √¢ngulo not√°vel. Seu valor √© 1/2, que √© 0.5." },
        { text: "Qual o valor da tangente(45¬∞)?", options: ["‚àö2", "0.5", "1", "Indefinido"], correct: 2, explanation: "A tangente √© o cateto oposto dividido pelo adjacente. Em 45¬∞, os catetos s√£o iguais, ent√£o o resultado √© 1." },
        { text: "O valor de cos(0¬∞) √©:", options: ["1", "0", "-1", "0.5"], correct: 0, explanation: "No in√≠cio do c√≠rculo trigonom√©trico (0¬∞), a proje√ß√£o no eixo X (cosseno) √© m√°xima, valendo 1." },
        { text: "O valor de cos(90¬∞) √©:", options: ["1", "0", "-1", "‚àö2/2"], correct: 1, explanation: "A 90¬∞, a proje√ß√£o do √¢ngulo no eixo X (cosseno) √© zero." },
        { text: "Um papagaio est√° no ombro de um pirata. O mastro do navio tem 10m de altura e o papagaio voa at√© o topo. Se a dist√¢ncia do pirata at√© a base do mastro √© 10m, qual o √¢ngulo de vis√£o do pirata?", options: ["30¬∞", "60¬∞", "45¬∞", "90¬∞"], correct: 2, explanation: "Se o cateto oposto (altura) e o cateto adjacente (dist√¢ncia) s√£o iguais (10m), o tri√¢ngulo √© is√≥sceles, e o √¢ngulo √© de 45¬∞." }
    ],
    medium: [
        { text: "O valor de cos(180¬∞) √©:", options: ["1", "0", "-1", "Indefinido"], correct: 2, explanation: "No c√≠rculo trigonom√©trico, 180¬∞ est√° no ponto mais √† esquerda do eixo x, que corresponde ao valor -1." },
        { text: "Se a hipotenusa de um mapa √© 10 e o cateto OPOSTO √© 6, qual o SENO do √¢ngulo?", options: ["0.8 (cosseno)", "1.66", "10/6", "0.6"], correct: 3, explanation: "Seno √© Cateto Oposto / Hipotenusa. Portanto, 6 / 10 = 0.6." },
        { text: "Qual o valor de sen(270¬∞)?", options: ["0", "-1", "1", "Indefinido"], correct: 1, explanation: "No c√≠rculo trigonom√©trico, 270¬∞ est√° no ponto mais baixo do eixo y, que corresponde ao valor -1 para o seno." },
        { text: "Um navio navega 200 milhas a leste e depois 200 milhas ao norte. Qual a dist√¢ncia total em linha reta da origem?", options: ["200 milhas", "400 milhas", "282.8 milhas", "346.4 milhas"], correct: 2, explanation: "Usando Pit√°goras (a¬≤ + b¬≤ = c¬≤), temos 200¬≤ + 200¬≤ = c¬≤. c = ‚àö(80000) ‚âà 282.8 milhas." },
        { text: "Converter œÄ/2 radianos para graus resulta em:", options: ["45¬∞", "180¬∞", "270¬∞", "90¬∞"], correct: 3, explanation: "Sabendo que œÄ radianos √© igual a 180¬∞, ent√£o œÄ/2 √© metade disso, ou seja, 90¬∞." }
    ],
    hard: [
        { text: "Qual √© a identidade trigonom√©trica fundamental?", options: ["sen¬≤(x) + cos¬≤(x) = 1", "sen(x) / cos(x) = cot(x)", "sen¬≤(x) - cos¬≤(x) = 1", "1 + cot¬≤(x) = cossec¬≤(x)"], correct: 0, explanation: "A Rela√ß√£o Fundamental da Trigonometria diz que a soma dos quadrados do seno e do cosseno de um mesmo √¢ngulo √© sempre 1." },
        { text: "A Lei dos Cossenos √© a¬≤ = b¬≤ + c¬≤ - ...?", options: ["2bc¬∑sen(A)", "bc¬∑cos(A)", "2bc¬∑cos(A)", "2ab¬∑cos(C)"], correct: 2, explanation: "A f√≥rmula completa da Lei dos Cossenos √© a¬≤ = b¬≤ + c¬≤ - 2bc¬∑cos(A), relacionando os lados de um tri√¢ngulo com o cosseno do √¢ngulo oposto." },
        { text: "O valor de sec(60¬∞) √©:", options: ["0.5", "2", "1.73", "N√£o existe"], correct: 1, explanation: "A secante √© o inverso do cosseno. Como cos(60¬∞) = 0.5, a sec(60¬∞) = 1 / 0.5 = 2." },
        { text: "A express√£o (sen(x) + cos(x))¬≤ √© igual a:", options: ["1", "1 + tan(x)", "sen¬≤(x) + cos¬≤(x)", "1 + sen(2x)"], correct: 3, explanation: "Expandindo, temos sen¬≤(x) + 2sen(x)cos(x) + cos¬≤(x). Como sen¬≤(x)+cos¬≤(x)=1 e 2sen(x)cos(x)=sen(2x), o resultado √© 1+sen(2x)." },
        { text: "Qual o valor de cos(135¬∞)?", options: ["‚àö2/2", "-1/2", "-‚àö2/2", "‚àö3/2"], correct: 2, explanation: "O √¢ngulo de 135¬∞ est√° no segundo quadrante, onde o cosseno √© negativo. Seu √¢ngulo de refer√™ncia √© 45¬∞, ent√£o cos(135¬∞) = -cos(45¬∞) = -‚àö2/2." }
    ]
};

// --- Elementos do DOM ---
const pinButton = document.getElementById('pin-button');
const readyButton = document.getElementById('ready-button');
const answersGrid = document.getElementById('answers-grid');
const difficultyContainer = document.getElementById('difficulty-container');
const reviewButton = document.getElementById('review-button');
const restartGameButton = document.getElementById('restart-game-button');

const sounds = {
    music: document.getElementById('music-bg'),
    click: document.getElementById('sound-click'),
    correct: document.getElementById('sound-correct'),
    wrong: document.getElementById('sound-wrong'),
    kraken: document.getElementById('sound-kraken')
};

// --- Vari√°veis Globais ---
let players = [];
let playerNickname = "Voc√™";
let currentQuestionIndex = 0;
let timerInterval;
let selectedQuestions = [];
let playerAnswers = [];

// --- Fun√ß√µes Principais ---

function playSound(soundName) {
    const sound = sounds[soundName];
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => {});
    }
}

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// --- L√≥gica das Telas ---

pinButton.addEventListener('click', () => {
    playSound('click');
    if (document.getElementById('pin-input').value === '2025') {
        switchScreen('lobby-screen');
        // Tenta tocar a m√∫sica ap√≥s a primeira intera√ß√£o do usu√°rio
        document.body.addEventListener('click', () => {
            if (sounds.music.paused) {
                sounds.music.play().catch(e => {});
            }
        }, { once: true });
        setupLobby();
    }
});

function setupLobby() {
    players = [];
    const botNames = ["Barba-Roxa", "Anne Bonny", "Olho de Vidro"];
    const playerGrid = document.getElementById('player-grid');
    playerGrid.innerHTML = '';
    botNames.forEach((name, index) => {
        setTimeout(() => {
            if (players.length < 4) {
                players.push({ name, score: 0, isBot: true });
                const card = document.createElement('div');
                card.className = 'player-card';
                card.textContent = `üè¥‚Äç‚ò†Ô∏è ${name}`;
                card.style.animationDelay = `${index * 0.2}s`;
                playerGrid.appendChild(card);
            }
        }, (index + 1) * 1000);
    });
    document.getElementById('nickname-input').value = '';
    document.getElementById('nickname-setup').style.display = 'flex';
}

readyButton.addEventListener('click', () => {
    playSound('click');
    playerNickname = document.getElementById('nickname-input').value || "Pirata An√¥nimo";
    players.unshift({ name: playerNickname, score: 0, isBot: false });

    const card = document.createElement('div');
    card.className = 'player-card';
    card.textContent = `ü¶ú ${playerNickname}`;
    document.getElementById('player-grid').prepend(card);

    document.getElementById('nickname-setup').style.display = 'none';
    switchScreen('difficulty-screen');
});

difficultyContainer.addEventListener('click', (e) => {
    const card = e.target.closest('.difficulty-card');
    if (card) {
        playSound('click');
        const difficulty = card.dataset.difficulty;
        selectedQuestions = questionsDB[difficulty];
        startGame();
    }
});

function startGame() {
    currentQuestionIndex = 0;
    playerAnswers = [];
    players.forEach(p => p.score = 0); // Reseta a pontua√ß√£o
    showQuestion();
}

function showQuestion() {
    if (currentQuestionIndex >= selectedQuestions.length) {
        showPodium();
        return;
    }

    const isKrakenRound = currentQuestionIndex === selectedQuestions.length - 1;
    document.getElementById('kraken-banner').style.display = isKrakenRound ? 'block' : 'none';
    if (isKrakenRound) playSound('kraken');

    switchScreen('game-screen');
    const question = selectedQuestions[currentQuestionIndex];
    const player = players.find(p => !p.isBot);

    document.getElementById('question-counter').textContent = `Quest√£o ${currentQuestionIndex + 1}/${selectedQuestions.length}`;
    document.getElementById('player-score').textContent = `üí∞ ${player.score}`;
    document.getElementById('question-text').textContent = question.text;

    document.querySelectorAll('.answer-btn').forEach((btn, i) => {
        btn.querySelector('.answer-text').textContent = question.options[i];
        btn.className = 'answer-btn';
        btn.disabled = false;
        btn.dataset.index = i;
    });
    startTimer(20);
}

function startTimer(duration) {
    const fuseEl = document.getElementById('timer-fuse');
    const sparkEl = document.getElementById('timer-spark');

    fuseEl.style.transition = 'none';
    sparkEl.style.transition = 'none';
    fuseEl.style.transform = 'scaleX(1)';
    sparkEl.style.left = '100%';

    setTimeout(() => {
        fuseEl.style.transition = `transform ${duration}s linear`;
        sparkEl.style.transition = `left ${duration}s linear`;
        fuseEl.style.transform = 'scaleX(0)';
        sparkEl.style.left = '0%';
    }, 100);

    timerInterval = setTimeout(() => handleAnswer(-1), duration * 1000);
}

answersGrid.addEventListener('click', (e) => {
    const button = e.target.closest('.answer-btn');
    if (button && !button.disabled) {
        clearTimeout(timerInterval);
        document.getElementById('timer-fuse').style.transition = 'none';
        document.getElementById('timer-spark').style.transition = 'none';
        handleAnswer(parseInt(button.dataset.index));
    }
});

function handleAnswer(selectedIndex) {
    playerAnswers.push({ question: selectedQuestions[currentQuestionIndex], answered: selectedIndex });
    playSound(selectedIndex === -1 ? 'wrong' : 'click');
    document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);

    const question = selectedQuestions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    let pointsGained = 0;

    if (isCorrect) {
        playSound('correct');
        const timeRemaining = parseFloat(window.getComputedStyle(document.getElementById('timer-fuse')).transform.split(',')[4].trim());
        pointsGained = Math.round(500 + 500 * timeRemaining);
        if (currentQuestionIndex === selectedQuestions.length - 1) {
            pointsGained *= 2;
        }
        players.find(p => !p.isBot).score += pointsGained;
    } else {
        playSound('wrong');
    }

    document.querySelector(`.answer-btn[data-index='${question.correct}']`).classList.add('correct');
    if (!isCorrect && selectedIndex !== -1) {
        document.querySelector(`.answer-btn[data-index='${selectedIndex}']`).classList.add('incorrect');
    }

    players.filter(p => p.isBot).forEach(bot => {
        if (Math.random() < 0.8) bot.score += Math.round(400 + Math.random() * 400);
    });

    setTimeout(() => showFeedback(isCorrect, pointsGained), 2000);
}

function showFeedback(isCorrect, pointsGained) {
    const feedbackScreen = document.getElementById('feedback-screen');
    const feedbackText = document.getElementById('feedback-text');
    const pointsText = document.getElementById('points-text');
    const explanationText = document.getElementById('explanation-text');

    feedbackScreen.className = `screen active ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}`;

    if (isCorrect) {
        feedbackText.textContent = "TESOURO!";
        pointsText.textContent = `+${pointsGained} Dobr√µes!`;
        pointsText.style.display = 'block';
        explanationText.style.display = 'none';
    } else {
        feedbackText.textContent = "MARUJO!";
        pointsText.style.display = 'none';
        explanationText.style.display = 'block';
        const question = selectedQuestions[currentQuestionIndex];
        const correctOptionText = question.options[question.correct];
        explanationText.innerHTML = `A resposta certa era: <strong>${correctOptionText}</strong>.<br>${question.explanation}`;
    }
    setTimeout(showLeaderboard, 5000);
}

function showLeaderboard() {
    switchScreen('leaderboard-screen');
    players.sort((a, b) => b.score - a.score);
    const listEl = document.getElementById('leaderboard-list');
    listEl.innerHTML = `<li class="leaderboard-item" style="background: none; border: none; box-shadow: none; color: white; text-shadow: 2px 2px 4px black; font-family: 'Bangers', cursive; font-size: 2.5rem;"><span>PROCURADO</span><span>RECOMPENSA</span></li>`;

    players.slice(0, 5).forEach((player, index) => {
        const item = document.createElement('li');
        item.className = 'leaderboard-item';
        item.style.animationDelay = `${index * 0.2}s`;
        item.innerHTML = `<span>${player.isBot ? 'üè¥‚Äç‚ò†Ô∏è' : 'ü¶ú'} ${player.name}</span><strong>üí∞ ${player.score}</strong>`;
        listEl.appendChild(item);
    });

    setTimeout(() => {
        currentQuestionIndex++;
        showQuestion();
    }, 5000);
}

function showPodium() {
    switchScreen('podium-screen');
    sounds.music.pause();
    players.sort((a, b) => b.score - a.score);
    const top3 = players.slice(0, 3);

    document.querySelector('#podium-1 .podium-name').textContent = top3[0]?.name || '-';
    document.querySelector('#podium-1 .podium-score').textContent = `üí∞ ${top3[0]?.score || 0}`;
    document.querySelector('#podium-2 .podium-name').textContent = top3[1]?.name || '-';
    document.querySelector('#podium-2 .podium-score').textContent = `üí∞ ${top3[1]?.score || 0}`;
    document.querySelector('#podium-3 .podium-name').textContent = top3[2]?.name || '-';
    document.querySelector('#podium-3 .podium-score').textContent = `üí∞ ${top3[2]?.score || 0}`;
}

reviewButton.addEventListener('click', () => {
    playSound('click');
    switchScreen('review-screen');
    const listEl = document.getElementById('review-list');
    listEl.innerHTML = '';
    playerAnswers.forEach((answerData, i) => {
        const { question, answered } = answerData;
        const isPlayerCorrect = answered === question.correct;
        const playerAnswerText = answered === -1 ? "Sem resposta" : question.options[answered];

        const item = document.createElement('li');
        item.className = 'review-item';
        item.innerHTML = `
            <h4>${i+1}. ${question.text}</h4>
            <p>Sua resposta: <span class="review-answer ${isPlayerCorrect ? '' : 'player-wrong'}">${playerAnswerText}</span></p>
            <p>Resposta correta: <span class="review-answer correct-answer">${question.options[question.correct]}</span></p>
            <p><strong>Explica√ß√£o do Capit√£o:</strong> ${question.explanation}</p>
        `;
        listEl.appendChild(item);
    });
});

restartGameButton.addEventListener('click', () => {
    playSound('click');
    location.reload();
});
